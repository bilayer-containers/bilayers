from ipywidgets import widgets, VBox, HBox, Tab, Accordion
from IPython.display import display
import tempfile
import os
import nbformat as nbf
import json

{% autoescape false %}
parameters = {{parameters}}
exec_function = {{exec_function}}
outputs = {{outputs}}

{% endautoescape %}


beginner_widgets = []
advanced_widgets = []

param_vars = []

# Appending args in cli_command
cli_command = []
cli_command.append(exec_function['cli_command'])

radio_options = {
    {% for param_conf in parameters if param_conf.type == 'Radio' -%}
        "{{ param_conf.label | lower | replace(' ', '_') }}": {
            {% for option in param_conf.options %}
            "{{ option.label }}": "{{ option.value }}"{% if not loop.last -%}, {%- endif %}
            {%- endfor %}
        }{% if not loop.last -%}, {%- endif %}
    {% endfor -%}
    }

{% for param_conf in parameters -%}
{% if param_conf.type == 'Files' and param_conf.file_count == "multiple" %}
{{ param_conf.label | lower | replace(" ", "_") }} = widgets.FileUpload(multiple=True)
{% elif param_conf.type == 'Files' and param_conf.file_count == "single" %}
{{ param_conf.label | lower | replace(" ", "_") }} = widgets.FileUpload(multiple=False)
{% elif param_conf.type == 'Radio' %}
{{ param_conf.label | lower | replace(" ", "_") }} = widgets.RadioButtons(options=[{% for option in param_conf.options %}("{{ option.label }}", "{{ option.value }}"){% if not loop.last %}, {% endif %}{% endfor %}], value="{{ param_conf.default }}")
{% elif param_conf.type == 'Integer' %}
{{ param_conf.label | lower | replace(" ", "_") }} = widgets.IntText(value={{ param_conf.default }})
{% elif param_conf.type == 'Float' %}
{{ param_conf.label | lower | replace(" ", "_") }} = widgets.FloatText(value={{ param_conf.default }})
{% elif param_conf.type == 'Textbox' %}
{{ param_conf.label | lower | replace(" ", "_") }} = widgets.Textarea(value="{{ param_conf.default if param_conf.default is not none else '' }}")
{% elif param_conf.type == 'Checkbox' %}
{{ param_conf.label | lower | replace(" ", "_") }} = widgets.Checkbox(value={{ param_conf.value }})
{%- endif %}

# Add a description label
{{ "desc_" + param_conf.label | lower | replace(" ", "_") }}  = widgets.HTML(value = "<b>{{ param_conf['label'] }} </b> :  {{ param_conf.get('description', '') }}")

# Add widget and description to accordion
tab = Tab(children=[HBox([widgets.Label("{{ param_conf['label'] }}"), {{ param_conf.label | lower | replace(" ", "_") }}]), {{ "desc_" + param_conf.label | lower | replace(" ", "_") }}])
tab.set_title(0, "{{ param_conf['label'] }}")
tab.set_title(1, "Description")

# Append the corresponding cli_tag, widget to param_vars
{% if param_conf.type == 'Files' %}
param_vars.append(("{{ param_conf['cli_tag'] }}", {{ param_conf.label | lower | replace(" ", "_") }}, "{{ param_conf.get('folder_name', '') }}"))
{% else %}
param_vars.append(("{{ param_conf['cli_tag'] }}", {{ param_conf.label | lower | replace(" ", "_") }}))
{% endif %}

{% if param_conf.mode == 'beginner' -%}
beginner_widgets.append(tab)
{% else %}
advanced_widgets.append(tab)
{%- endif %}
{%- endfor %}

{# Parsing outputs to get the `savedir` foldername - Not much effect in JupyterNB except the case `cli_tag != None` #}
{% for output_conf in outputs -%}
{% if output_conf.type == 'Textbox' -%}
{% if output_conf.output_dir_set == False -%}
{{ output_conf.label | lower | replace(" ", "_") }} = widgets.Textarea(value="{{ output_conf.default }}", disabled=True)
{% else -%}
{{ output_conf.label | lower | replace(" ", "_") }} = widgets.Textarea(value="{{ output_conf.default }}")
{% endif -%}

# Add a description label
{{ "desc_" + output_conf.label | lower | replace(" ", "_") }}  = widgets.HTML(value = "<b>{{ output_conf['label'] }} </b> :  {{ output_conf.get('description', '') }}")

# Add widget and description to accordion
tab = Tab(children=[HBox([widgets.Label("{{ output_conf['label'] }}"), {{ output_conf.label | lower | replace(" ", "_") }}]), {{ "desc_" + output_conf.label | lower | replace(" ", "_") }}])
tab.set_title(0, "{{ output_conf['label'] }}")
tab.set_title(1, "Description")

# Append the corresponding cli_tag, widget to param_vars
param_vars.append(("{{ output_conf['cli_tag'] }}", {{ output_conf.label | lower | replace(" ", "_") }}))

{% if output_conf.mode == 'beginner' -%}
beginner_widgets.append(tab)
{% else %}
advanced_widgets.append(tab)
{%- endif %}

{%- endif %}
{%- endfor %}


acc = Accordion()
# Add beginner_widgets to the first section
acc.children = [VBox(beginner_widgets)]
acc.set_title(0, "Beginner's Section")
# Add advanced_widgets to the second section
acc.children = acc.children + (VBox(advanced_widgets),)
acc.set_title(1, "Advanced Section")

def construct_cli_command():
    cli_command = ["{{ exec_function.cli_command }}"]
    for param_var in param_vars:
            cli_tag = param_var[0]
            widget = param_var[1]
            
            if len(param_var) == 3:  # This is a 'Files' type
                folder_name = param_var[2]
            
                if isinstance(widget, widgets.FileUpload):
                    cli_command.append(f"{cli_tag} {folder_name}")
            
            else:  # Handling other types then Files
                if isinstance(widget, widgets.Checkbox):
                    if widget.value == True:
                        cli_command.append(cli_tag)
                    else:
                        continue
                elif isinstance(widget, widgets.Textarea):
                    if widget.value == "" or cli_tag == "None":
                        continue
                    cli_command.append(f"{cli_tag} {widget.value}")
                elif isinstance(widget, widgets.RadioButtons):
                    if widget.value != "None":
                        cli_command.append(f"{cli_tag} {widget.value}")
                    else:
                        continue
                else:
                    cli_command.append(f"{cli_tag} {widget.value}")

    # Add hidden arguments to the command
    {% if exec_function.hidden_args %}
    {% for arg in exec_function.hidden_args %}
    if {{ arg.value }} == True:
        cli_command.append("{{ arg.cli_tag }}")
    else:
        cli_command.append("{{ arg.cli_tag }} {{ arg.value }}")
    {% endfor %}
    {% endif %}

    return " ".join(cli_command)

def update_command(change):
    cli_command.value = construct_cli_command()

cli_command = widgets.Textarea(value=construct_cli_command(), description="CLI Command")

for param_var in param_vars:
    widget = param_var[1]
    widget.observe(update_command, names='value')

display(acc, cli_command)


if __name__ == "main":
    print("Hello World")