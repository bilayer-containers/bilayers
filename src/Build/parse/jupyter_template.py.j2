from ipywidgets import widgets, VBox, HBox, Tab, Accordion
from IPython.display import display
import tempfile
import os
import nbformat as nbf
import json

{% autoescape false %}
inputs = {{inputs}}
exec_function = {{exec_function}}
outputs = {{outputs}}

{% endautoescape %}


beginner_widgets = []
advanced_widgets = []

input_vars = []

# Appending args in cli_command
cli_command = []
cli_command.append(exec_function['cli_command'])

radio_options = {
    {% for input_conf in inputs if input_conf.type == 'Radio' -%}
        "{{ input_conf.label | lower | replace(' ', '_') }}": {
            {% for option in input_conf.options %}
            "{{ option.label }}": "{{ option.value }}"{% if not loop.last -%}, {%- endif %}
            {%- endfor %}
        }{% if not loop.last -%}, {%- endif %}
    {% endfor -%}
    }

{% for input_conf in inputs -%}
{% if input_conf.type == 'Files' and input_conf.file_count == "multiple" %}
{{ input_conf.label | lower | replace(" ", "_") }} = widgets.FileUpload(multiple=True)
{% elif input_conf.type == 'Files' and input_conf.file_count == "single" %}
{{ input_conf.label | lower | replace(" ", "_") }} = widgets.FileUpload(multiple=False)
{% elif input_conf.type == 'Radio' %}
{{ input_conf.label | lower | replace(" ", "_") }} = widgets.RadioButtons(options=[{% for option in input_conf.options %}("{{ option.label }}", "{{ option.value }}"){% if not loop.last %}, {% endif %}{% endfor %}], value="{{ input_conf.default }}")
{% elif input_conf.type == 'Integer' %}
{{ input_conf.label | lower | replace(" ", "_") }} = widgets.IntText(value={{ input_conf.default }})
{% elif input_conf.type == 'Float' %}
{{ input_conf.label | lower | replace(" ", "_") }} = widgets.FloatText(value={{ input_conf.default }})
{% elif input_conf.type == 'Textbox' %}
{{ input_conf.label | lower | replace(" ", "_") }} = widgets.Textarea(value="{{ input_conf.default if input_conf.default is not none else '' }}")
{% elif input_conf.type == 'Checkbox' %}
{{ input_conf.label | lower | replace(" ", "_") }} = widgets.Checkbox(value={{ input_conf.value }})
{%- endif %}

# Add a description label
{{ "desc_" + input_conf.label | lower | replace(" ", "_") }}  = widgets.HTML(value = "<b>{{ input_conf['label'] }} </b> :  {{ input_conf.get('description', '') }}")

# Add widget and description to accordion
tab = Tab(children=[HBox([widgets.Label("{{ input_conf['label'] }}"), {{ input_conf.label | lower | replace(" ", "_") }}]), {{ "desc_" + input_conf.label | lower | replace(" ", "_") }}])
tab.set_title(0, "{{ input_conf['label'] }}")
tab.set_title(1, "Description")

# Append the corresponding cli_tag, widget to input_vars
# Append the corresponding cli_tag, widget to input_vars
{% if input_conf.type == 'Files' %}
input_vars.append(("{{ input_conf['cli_tag'] }}", {{ input_conf.label | lower | replace(" ", "_") }}, {{ input_conf.get('volume_mount', 'False') }}, "{{ input_conf.get('folder_name', '') }}"))
{% else %}
input_vars.append(("{{ input_conf['cli_tag'] }}", {{ input_conf.label | lower | replace(" ", "_") }}))
{% endif %}

{% if input_conf.mode == 'beginner' -%}
beginner_widgets.append(tab)
{% else %}
advanced_widgets.append(tab)
{%- endif %}
{%- endfor %}

acc = Accordion()
# Add beginner_widgets to the first section
acc.children = [VBox(beginner_widgets)]
acc.set_title(0, "Beginner's Section")
# Add advanced_widgets to the second section
acc.children = acc.children + (VBox(advanced_widgets),)
acc.set_title(1, "Advanced Section")

def construct_cli_command():
    cli_command = ["{{ exec_function.cli_command }}"]
    for input_var in input_vars:
            cli_tag = input_var[0]
            widget = input_var[1]
            
            if len(input_var) == 4:  # This is a 'Files' type
                volume_mount = input_var[2]
                folder_name = input_var[3]
            
                if isinstance(widget, widgets.FileUpload):
                {# Regardless, Volume-Mount is true or False, we are just allowing Volume Mount at the Jupyter Level #}
                cli_command.append(f"{cli_tag} {folder_name}")
                    {# if volume_mount: 
                        # If volume_mount is True, add the user provided folder_name to the cli_command 
                        cli_command.append(f"{cli_tag} {folder_name}")
                    else:
                        # Create a temporary directory and move all the input files there
                        temp_dir = tempfile.mkdtemp()
                        for uploaded_file in widget.value:  
                            file_content = uploaded_file['content']
                            file_path = os.path.join(temp_dir, uploaded_file['name'])
                            with open(file_path, 'wb') as f:
                                # Convert memoryview to bytes
                                f.write(file_content.tobytes())  
                        cli_command.append(f"{cli_tag} {temp_dir}") #}
            
            else:  # Handling other types then Files
                if isinstance(widget, widgets.Checkbox):
                    if widget.value == True:
                        cli_command.append(cli_tag)
                    else:
                        continue
                elif isinstance(widget, widgets.Textarea):
                    if widget.value == "":
                        continue
                    cli_command.append(f"{cli_tag} {widget.value}")
                elif isinstance(widget, widgets.RadioButtons):
                    if widget.value != "None":
                        cli_command.append(f"{cli_tag} {widget.value}")
                    else:
                        continue
                else:
                    cli_command.append(f"{cli_tag} {widget.value}")

    # Add hidden arguments to the command
    {% if exec_function.hidden_args %}
    {% for arg in exec_function.hidden_args %}
    if {{ arg.value }} == True:
        cli_command.append("{{ arg.cli_tag }}")
    else:
        cli_command.append("{{ arg.cli_tag }} {{ arg.value }}")
    {% endfor %}
    {% endif %}

    return " ".join(cli_command)

def update_command(change):
    cli_command.value = construct_cli_command()

cli_command = widgets.Textarea(value=construct_cli_command(), description="CLI Command")

for input_var in input_vars:
    widget = input_var[1]
    widget.observe(update_command, names='value')

display(acc, cli_command)


if __name__ == "main":
    print("Hello World")