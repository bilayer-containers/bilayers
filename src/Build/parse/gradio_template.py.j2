import os
import gradio as gr
import subprocess
import tempfile
import shutil

def generate_cli_command(cli_tags, **kwargs):
    cli_command = ["{{ exec_function.cli_command }}"]

    # Radio options mapping
    radio_options = {
    {% if parameters is not none %}
    {% for param_conf in parameters if param_conf.type == 'Radio' -%}
        "{{ param_conf.label | lower | replace(' ', '_') }}": {
            {% for option in param_conf.options -%}
            "{{ option.label }}": "{{ option.value }}"{% if not loop.last %}, {% endif %}
            {%- endfor %}
        },
    {%- endfor %}
    {% endif %}
    {% if display_only is not none %}
    {% for display_only_conf in display_only if display_only_conf.type == 'Radio' -%}
        "{{ display_only_conf.label | lower | replace(' ', '_') }}": {
            {% for option in display_only_conf.options -%}
            "{{ option.label }}": "{{ option.value }}"{% if not loop.last %}, {% endif %}
            {%- endfor %}
        },
    {%- endfor %}
    {% endif %}
    }


    folder_name = None
    output_folder_name = None
    append_value = None

    # Update cli_args with user parameters or defaults
    for key, value in kwargs.items():
        if key in cli_tags:
            cli_tag = cli_tags[key].get("cli_tag", None)
            default = cli_tags[key].get("default", None)

            if isinstance(value, bool):
                append_value = cli_tags[key].get("append_value", False)
                if value:  
                    if append_value:
                        cli_command.append(f"{cli_tag} True")
                    else:
                        cli_command.append(f"{cli_tag}")
                else:
                    if append_value:
                        cli_command.append(f"{cli_tag} False")
            else:
                # Handle Radio type mappings dynamically
                if key in radio_options and value in radio_options[key]:
                    value = radio_options[key][value]
                    if value == "None":
                        continue
                # If the parameter is a list (mainly for parameter files), convert it to a string
                elif isinstance(value, list):
                    folder_name = cli_tags[key].get("folder_name")
                    print("Folder Name:", folder_name)
                    os.makedirs(folder_name, exist_ok=True)
                    print("Value of dir", value)
                    for file_path in value:
                        shutil.copy(file_path, folder_name)
                    value = folder_name
                # If the parameter is a TextBox, check if it has a directory-name i.e. it's coming from ouputs
                elif isinstance(value, str) and value!="":
                    output_dir_set = cli_tags[key].get("output_dir_set")
                    if output_dir_set == True:
                        output_folder_name = value
                        os.makedirs(output_folder_name, exist_ok=True)
                        if cli_tag != "None":
                            value = output_folder_name 
                    elif output_dir_set == False:
                        output_folder_name = default
                        os.makedirs(default, exist_ok=True)
                        if cli_tag != "None":
                            value = default
            
                # If the value of (textbox) is empty string, set it to None
                if value == "":
                    value = None
                # If the cli_tag is None, don't include it in the command but if cli_tag is "" then just include the value
                elif value is not None:
                    if cli_tag == "":  # Only append the value if cli_tag is empty string
                        cli_command.append(f"{value}")
                    elif cli_tag != "None":  # Append both cli_tag and value if cli_tag is neither None nor empty
                        cli_command.append(f"{cli_tag} {value}")


   # Add hidden arguments to the command
    {% if exec_function.hidden_args %}
    {% for arg in exec_function.hidden_args %}
    if {{ arg.value }} == True:
        cli_command.append("{{ arg.cli_tag }}")
    else:
        cli_command.append("{{ arg.cli_tag }} {{ arg.value }}")
    {% endfor %}
    {% endif %}
    
    return " ".join(cli_command), folder_name, output_folder_name

# Dynamically define on_submit with the exact parameter arguments
def on_submit(
{% if parameters is not none %}
{% for param_conf in parameters -%}
{% if param_conf.type == 'Files' %}
{{param_conf.label | lower | replace(" ", "_")}}_description,
{{ param_conf.label | lower | replace(" ", "_") }},
{% else %}
{{ param_conf.label | lower | replace(" ", "_") }},
{% endif %}
{% endfor -%}
{% endif %}
{% if display_only is not none %}
{% for display_only_conf in display_only -%}
{% if display_only_conf.type == 'Files' %}
{{display_only_conf.label | lower | replace(" ", "_")}}_description,
{{ display_only_conf.label | lower | replace(" ", "_") }},
{% else %}
{{ display_only_conf.label | lower | replace(" ", "_") }},
{% endif %}
{% endfor -%}
{% endif %}
):

    kwargs = {
    {% if parameters is not none %}
    {% for param_conf in parameters %}
        "{{ param_conf.label | lower | replace(' ', '_') }}": {{ param_conf.label | lower | replace(' ', '_') }},
    {% endfor %}
    {% endif %}
    {% if display_only is not none %}
    {% for display_only_conf in display_only %}
        "{{ display_only_conf.label | lower | replace(' ', '_') }}": {{ display_only_conf.label | lower | replace(' ', '_') }},
    {% endfor %}
    {% endif %}
    }

    # Mapping of parameter tags to CLI tags
    cli_tags = {
    {% for param_conf in parameters %}
    "{{ param_conf.label | lower | replace(' ', '_') }}": {
        "cli_tag": "{{ param_conf.cli_tag }}",
        "default": "{{ param_conf.default }}",
        {% if param_conf.type == 'Checkbox' %}
            {% if param_conf.append_value is defined %}
        "append_value": {{ param_conf.append_value }},
            {% endif %}
        {% endif %}
        {% if param_conf.type == 'Files' %}
        "folder_name": "{{ param_conf.folder_name }}"
        {% endif %}
        {% if param_conf.type == 'Textbox' %}
            {% if param_conf.output_dir_set is defined %}
        "output_dir_set": {{ param_conf.output_dir_set }}
            {% endif %}
        {% endif %}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
}


    print("Received parameters:", kwargs)

    # Generate the CLI command
    cli_command, folder_name, output_folder_name = generate_cli_command(cli_tags, **kwargs)
    print("Generated CLI command:", cli_command)

  

    # Execute the CLI command
    try:
        result = subprocess.run(cli_command, shell=True, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        print("Command output:", result.stdout.decode())
        
        # Check if output_folder_name is not None and is a directory
        if output_folder_name and os.path.exists(output_folder_name) and os.path.isdir(output_folder_name):
            print("Folder exists")
            # Display Output files
            output_files = [os.path.join(output_folder_name, f) for f in os.listdir(output_folder_name) if os.path.isfile(os.path.join(output_folder_name, f))]
        else:
            print("Folder does not exist or output_folder_name is None")
            output_files = []
        

        return output_files

    except subprocess.CalledProcessError as e:
        error_message = "Please take a screenshot of this error and raise an issue at the Bilayers repository on GitHub."
        error_message += f"Command failed with error: {e.stderr.decode()}\n\n"
        raise gr.Error(error_message)
        

{% if parameters is not none %}
{% for param_conf in parameters %}

{% if param_conf.type == 'Radio' %}
{{ param_conf.label | lower | replace(" ", "_") }} = gr.Radio(label="{{ param_conf.label }}", info="{{ param_conf.description }}",  choices=[{% for option in param_conf.options %}"{{ option.label }}"{% if not loop.last %}, {% endif %}{% endfor %}], value="{{ param_conf.default }}")
{% elif param_conf.type == 'Integer' %}
{{ param_conf.label | lower | replace(" ", "_") }} = gr.Number(label="{{ param_conf.label }}", info="{{ param_conf.description }}", value={{ param_conf.default }})
{% elif param_conf.type == 'Float' %}
{{ param_conf.label | lower | replace(" ", "_") }} = gr.Number(label="{{ param_conf.label }}", info="{{ param_conf.description }}", value={{ param_conf.default }})
{% elif param_conf.type == 'Textbox' and param_conf.output_dir_set == False %}
{{ param_conf.label | lower | replace(" ", "_") }} = gr.Textbox(label="{{ param_conf.label }}", info="{{ param_conf.description }}", value="{{ param_conf.default }}", interactive=False)
{% elif param_conf.type == 'Textbox' %}
{{ param_conf.label | lower | replace(" ", "_") }} = gr.Textbox(label="{{ param_conf.label }}", info="{{ param_conf.description }}", value="{{ param_conf.default }}")
{% elif param_conf.type == 'Checkbox' %}
{{ param_conf.label | lower | replace(" ", "_") }} = gr.Checkbox(label="{{ param_conf.label }}", info="{{ param_conf.description }}", value={{ param_conf.value }})
{% elif param_conf.type == 'Files' %}
{{ param_conf.label | lower | replace(" ", "_") }}_description = gr.Markdown(value="{{ param_conf.description }}")
{{ param_conf.label | lower | replace(" ", "_") }} = gr.Files(label="{{ param_conf.label }}", file_count="{{ param_conf.file_count }}")
{% endif %}
{% if param_conf.mode == "beginner" %}
{% if param_conf.type == 'Files' %}
{% endif %}
{% endif %}


{% endfor %}  
{% endif %}

{% if display_only is not none %}
{% for display_only_conf in display_only %}
{% if display_only_conf.type == 'Radio' %}
{{ display_only_conf.label | lower | replace(" ", "_") }} = gr.Radio(label="{{ display_only_conf.label }}", info="{{ display_only_conf.description }}",  choices=[{% for option in display_only_conf.options %}"{{ option.label }}"{% if not loop.last %}, {% endif %}{% endfor %}], value="{{ display_only_conf.default }}", interactive=False)
{% elif display_only_conf.type == 'Integer' %}
{{ display_only_conf.label | lower | replace(" ", "_") }} = gr.Number(label="{{ display_only_conf.label }}", info="{{ display_only_conf.description }}", value={{ display_only_conf.default }}, interactive=False)
{% elif display_only_conf.type == 'Float' %}
{{ display_only_conf.label | lower | replace(" ", "_") }} = gr.Number(label="{{ display_only_conf.label }}", info="{{ display_only_conf.description }}", value={{ display_only_conf.default }}, interactive=False)
{% elif display_only_conf.type == 'Textbox' %}
{{ display_only_conf.label | lower | replace(" ", "_") }} = gr.Textbox(label="{{ display_only_conf.label }}", info="{{ display_only_conf.description }}", value="{{ display_only_conf.default }}", interactive=False)
{% elif display_only_conf.type == 'Checkbox' %}
{{ display_only_conf.label | lower | replace(" ", "_") }} = gr.Checkbox(label="{{ display_only_conf.label }}", info="{{ display_only_conf.description }}", value={{ display_only_conf.value }}, interactive=False)
{% elif display_only_conf.type == 'Files' %}
{{ display_only_conf.label | lower | replace(" ", "_") }}_description = gr.Markdown(value="{{ display_only_conf.description }}")
{{ display_only_conf.label | lower | replace(" ", "_") }} = gr.Files(label="{{ display_only_conf.label }}", file_count="{{ display_only_conf.file_count }}", interactive=False)
{% endif %}
{% endfor %}
{% endif %}

{% for result_conf in results %}
{% if result_conf.type == 'Files' %}
{% endif %}
{% endfor %}

description_text = "Please cite the following while using Bilayers - Gradio Interface!\n\n"

{% for citation in citations.Bilayers %}
description_text += f"{{citation.name}}: {{citation.license}} - {{citation.description}}\n\n"
{% endfor %}

{% for citation in citations.Gradio %}
description_text += f"{{citation.name}}: {{citation.doi}} - {{citation.description}}\n\n"
{% endfor %}

{% for citation in citations.Algorithm %}
description_text += f"{{citation.name}}: {{citation.doi}} - {{citation.description}}\n\n"
{% endfor %}


{% for result_conf in results %}
{% if result_conf.type == 'Files' %}
{% endif %}
{% endfor %}




all_parameters = [
{% if parameters is not none %}
{% for param_conf in parameters %}
{% if param_conf.type == 'Files' %}
    {{param_conf.label | lower | replace(" ", "_")}}_description,
    {{ param_conf.label | lower | replace(" ", "_") }},
{% else %}
    {{ param_conf.label | lower | replace(" ", "_") }},
{% endif %}
{% endfor %}
{% endif %}
{% if display_only is not none %}
{% for display_only_conf in display_only %}
{% if display_only_conf.type == 'Files' %}
    {{ display_only_conf.label | lower | replace(" ", "_")}}_description,
    {{ display_only_conf.label | lower | replace(" ", "_") }},
{% else %}
    {{ display_only_conf.label | lower | replace(" ", "_") }},
{% endif %}
{% endfor %}
{% endif %}
]

results = [
{% for result_conf in results %}
{% if result_conf.type == 'Files' %}
gr.Files(label="{{ result_conf.label }}", file_count="{{ result_conf.file_count }}")
{% endif %}
{% endfor %}
]

app = gr.Interface(
    fn=on_submit, 
    inputs=all_parameters,
    outputs=results, 
    title="Gradio App",
    description=f"<div style='text-align: center'>{description_text}</div>"
)

if __name__ == "__main__":
    app.launch(server_name="0.0.0.0", server_port=8000)